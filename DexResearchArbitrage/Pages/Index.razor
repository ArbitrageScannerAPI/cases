@page "/"
@inject HttpClient Http
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime
@inject ITokenValidationService TokenValidationService
@inject IPoolsService PoolsService
@using DexResearchArbitrage.Models
@using DexResearchArbitrage.Services
@using System.Text.Json

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5">DEX Pool Explorer</MudText>
    <MudDivider Class="my-2" />
    
    <!-- Network and Token Input Section -->
    <MudGrid Class="mb-4">
        <MudItem xs="12" md="4">
            <MudSelect T="Network" 
                       Label="Select Network" 
                       @bind-Value="selectedNetwork"
                       Required="true"
                       RequiredError="Please select a network"
                       Variant="Variant.Outlined"
                       AnchorOrigin="Origin.BottomCenter">
                <MudSelectItem Value="Network.None" Disabled="true">-- Select Network --</MudSelectItem>
                <MudSelectItem Value="Network.Solana">Solana</MudSelectItem>
                <MudSelectItem Value="Network.Ethereum">Ethereum</MudSelectItem>
            </MudSelect>
        </MudItem>
        
        <MudItem xs="12" md="6">
            <MudTextField @bind-Value="tokenAddress"
                          Label="Token Address"
                          Placeholder="Enter or paste token address"
                          Variant="Variant.Outlined"
                          Immediate="false"
                          OnBlur="OnTokenAddressBlur"
                          Disabled="@(selectedNetwork == Network.None)"
                          Error="@hasValidationError"
                          ErrorText="@validationErrorMessage"
                          Adornment="Adornment.End"
                          AdornmentIcon="@(isValidating ? Icons.Material.Filled.HourglassEmpty : Icons.Material.Filled.Search)"
                          AdornmentColor="Color.Primary" />
        </MudItem>
        
        <MudItem xs="12" md="2" Class="d-flex align-center">
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       OnClick="ValidateAndLoadPools"
                       Disabled="@(selectedNetwork == Network.None || string.IsNullOrWhiteSpace(tokenAddress) || isValidating || isLoadingPools)">
                @if (isValidating || isLoadingPools)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Loading...</span>
                }
                else
                {
                    <span>Search Pools</span>
                }
            </MudButton>
        </MudItem>
    </MudGrid>
    
    <!-- Validated Token Info -->
    @if (validatedToken != null && validatedToken.IsValid)
    {
        <MudAlert Severity="Severity.Success" Class="mb-4" Dense="true">
            Token validated: @validatedToken.TokenSymbol (@validatedToken.TokenAddress)
        </MudAlert>
    }
    
    <!-- Filters Section (shown only when pools are loaded) -->
    @if (true) //(allPools.Count > 0)
    {
        <PoolFilters Filters="@filters" 
                     AvailableSecondTokens="@availableSecondTokens"
                     OnFiltersChanged="ApplyFilters" />
    }
    
    <!-- Pools Table -->
    @if (allPools.Count > 0)
    {
        <MudTable Items="@filteredPools" 
                  T="PoolInfo" 
                  Hover="true"
                  Bordered="true"
                  Breakpoint="Breakpoint.Sm"
                  FixedHeader="true"
                  Height="calc(100vh - 450px)"
                  Dense="true"
                  OnRowClick="OnPoolRowClick"
                  RowStyleFunc="@SelectedRowStyleFunc"
                  @bind-SelectedItem="selectedPool">
            <HeaderContent>
                <MudTh Style="width: 50px;">№</MudTh>
                <MudTh>DEX</MudTh>
                <MudTh>Pool Address</MudTh>
                <MudTh>Second Token</MudTh>
                <MudTh>TVL (USD)</MudTh>
                <MudTh>Swaps Count</MudTh>
                <MudTh>Arbitration</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="№">@(filteredPools.IndexOf(context) + 1)</MudTd>
                <MudTd DataLabel="DEX">@context.Dex</MudTd>
                <MudTd DataLabel="Pool Address">
                    <MudTooltip Text="@context.PoolAddress">
                        <span>@TruncateAddress(context.PoolAddress)</span>
                    </MudTooltip>
                </MudTd>
                <MudTd DataLabel="Second Token">
                    @if (!string.IsNullOrEmpty(context.SecondTokenSymbol))
                    {
                        <MudTooltip Text="@context.SecondTokenAddress">
                            <span>@context.SecondTokenSymbol</span>
                        </MudTooltip>
                    }
                    else
                    {
                        <MudTooltip Text="@context.SecondTokenAddress">
                            <span>@TruncateAddress(context.SecondTokenAddress)</span>
                        </MudTooltip>
                    }
                </MudTd>
                <MudTd DataLabel="TVL (USD)">@context.TvlUsd.ToString("N2")</MudTd>
                <MudTd DataLabel="Swaps Count">@context.CountSwaps</MudTd>
                <MudTd DataLabel="Arbitration">
                    @if (context.ArbitrationFlag)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" Size="Size.Small" />
                    }
                </MudTd>
            </RowTemplate>
        </MudTable>
        
        <!-- Total Records Info -->
        <MudPaper Class="pa-2 mt-2" Elevation="0">
            <MudText Typo="Typo.body2">
                Total records: <strong>@filteredPools.Count</strong>
                @if (filters.HasActiveFilters())
                {
                    <span> (filtered from @allPools.Count)</span>
                }
            </MudText>
        </MudPaper>
    }
    else if (isLoadingPools)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
        <MudText Align="Align.Center">Loading pools...</MudText>
    }
    else if (validatedToken != null && validatedToken.IsValid && allPools.Count == 0)
    {
        <MudAlert Severity="Severity.Info" Class="mt-4">
            No pools found for this token on @selectedNetwork.ToDisplayString().
        </MudAlert>
    }
</MudPaper>

@code {
    // State
    private Network selectedNetwork = Network.None;
    private string tokenAddress = string.Empty;
    private TokenValidationResult? validatedToken;
    
    // Pools data
    private List<PoolInfo> allPools = new();
    private List<PoolInfo> filteredPools = new();
    private PoolInfo? selectedPool;
    
    // Filters
    private PoolFiltersModel filters = new();
    private List<string> availableSecondTokens = new();
    
    // UI state
    private bool isValidating = false;
    private bool isLoadingPools = false;
    private bool hasValidationError = false;
    private string validationErrorMessage = string.Empty;

    private async Task OnTokenAddressBlur()
    {
        // Optional: Auto-validate on blur
        // await ValidateAndLoadPools();
    }

    private async Task ValidateAndLoadPools()
    {
        if (selectedNetwork == Network.None || string.IsNullOrWhiteSpace(tokenAddress))
            return;

        // Reset state
        hasValidationError = false;
        validationErrorMessage = string.Empty;
        allPools.Clear();
        filteredPools.Clear();
        filters.Reset();
        availableSecondTokens.Clear();

        // Step 1: Validate token
        isValidating = true;
        StateHasChanged();

        try
        {
            validatedToken = await TokenValidationService.ValidateTokenAsync(selectedNetwork, tokenAddress.Trim());

            if (!validatedToken.IsValid)
            {
                // Show error dialog similar to original project
                await ShowInvalidTokenDialog(validatedToken.ErrorMessage ?? "Invalid token address");
                
                // Clear input and set error state
                tokenAddress = string.Empty;
                hasValidationError = true;
                validationErrorMessage = validatedToken.ErrorMessage ?? "Invalid token address";
                validatedToken = null;
                
                isValidating = false;
                StateHasChanged();
                return;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Validation error: {ex.Message}");
            hasValidationError = true;
            validationErrorMessage = "Error validating token";
            isValidating = false;
            StateHasChanged();
            return;
        }

        isValidating = false;
        
        // Step 2: Load pools
        isLoadingPools = true;
        StateHasChanged();

        try
        {
            allPools = await PoolsService.GetPoolsByTokenAsync(selectedNetwork, tokenAddress.Trim());
            
            // Extract unique second tokens for filter dropdown
            availableSecondTokens = allPools
                .Select(p => !string.IsNullOrEmpty(p.SecondTokenSymbol) 
                    ? $"{p.SecondTokenSymbol} ({TruncateAddress(p.SecondTokenAddress)})" 
                    : p.SecondTokenAddress)
                .Distinct()
                .OrderBy(x => x)
                .ToList();
            
            // Apply initial (empty) filters
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading pools: {ex.Message}");
        }
        finally
        {
            isLoadingPools = false;
            StateHasChanged();
        }
    }

    private void ApplyFilters()
    {
        filteredPools = FilterPools(allPools, filters);
        StateHasChanged();
    }

    /// <summary>
    /// Client-side filtering logic (separated for testability)
    /// </summary>
    private List<PoolInfo> FilterPools(List<PoolInfo> pools, PoolFiltersModel filterModel)
    {
        var result = pools.AsEnumerable();

        // Filter by second token addresses
        if (filterModel.SecondTokenAddresses.Count > 0)
        {
            result = result.Where(p => 
                filterModel.SecondTokenAddresses.Any(f => 
                    f.Contains(p.SecondTokenAddress) || 
                    f.Contains(p.SecondTokenSymbol ?? "")));
        }

        // Filter by minimum TVL
        if (filterModel.MinTvlUsd > 0)
        {
            result = result.Where(p => p.TvlUsd >= filterModel.MinTvlUsd);
        }

        // Filter by swaps count
        if (filterModel.MinSwapCount > 0)
        {
            result = result.Where(p => p.CountSwaps >= filterModel.MinSwapCount);
        }

        // Filter by swaps date (if swap has timestamp)
        // TODO: Adjust based on actual API response - this assumes LastSwapTimestamp field
        if (filterModel.SwapsFromDate.HasValue)
        {
            result = result.Where(p => 
                p.LastSwapTimestamp.HasValue && 
                p.LastSwapTimestamp.Value >= filterModel.SwapsFromDate.Value);
        }

        // Filter by price difference percentage
        if (filterModel.MinPriceDiffPercent > 0)
        {
            result = result.Where(p => p.PriceDiffPercent >= filterModel.MinPriceDiffPercent);
        }

        return result.ToList();
    }

    private async Task ShowInvalidTokenDialog(string message)
    {
        var parameters = new DialogParameters
        {
            { "Message", message }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            CloseOnEscapeKey = true
        };

        await DialogService.ShowAsync<InvalidTokenDialog>("Invalid Token", parameters, options);
    }

    private void OnPoolRowClick(TableRowClickEventArgs<PoolInfo> args)
    {
        selectedPool = args.Item;
        
        // TODO: Implement pool click action (e.g., navigate to pool details, open external link)
        Console.WriteLine($"Pool clicked: {args.Item?.PoolAddress}");
        
        // Extension point for future functionality
        HandlePoolSelection(args.Item);
    }

    /// <summary>
    /// Extension point for handling pool selection
    /// </summary>
    private void HandlePoolSelection(PoolInfo? pool)
    {
        if (pool == null) return;
        
        // TODO: Implement desired action:
        // - Navigate to pool details page
        // - Open pool in DEX explorer
        // - Show pool details dialog
        // - etc.
    }

    private string SelectedRowStyleFunc(PoolInfo pool, int rowNumber)
    {
        if (selectedPool != null && selectedPool.PoolAddress == pool.PoolAddress)
        {
            return "background-color: #E3F2FD;";
        }
        return string.Empty;
    }

    private string TruncateAddress(string address)
    {
        if (string.IsNullOrEmpty(address) || address.Length <= 12)
            return address;
        
        return $"{address[..6]}...{address[^4..]}";
    }
}
