@namespace DexResearchArbitrage.Components
@using MudBlazor
@using DexResearchArbitrage.Models

<MudPaper Class="pa-4 mb-4">
    <MudText Typo="Typo.h6" Class="mb-3">Filters</MudText>

    <MudGrid>
        <!-- Second Token Filter -->
        <MudItem xs="12" md="6" lg="3">
            <MudSelect T="string"
                       Label="Second Token"
                       MultiSelection="true"
                       @bind-SelectedValues="SelectedSecondTokens"
                       Placeholder="All tokens"
                       Clearable="true"
                       Dense="true">
                @foreach (var token in AvailableSecondTokens)
                {
                    <MudSelectItem Value="@token">@token</MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <!-- Swaps From Date -->
        <MudItem xs="12" md="6" lg="2">
            <MudDatePicker Label="Swaps From Date"
                           Date="Filters.SwapsFromDate"
                           DateChanged="OnSwapsDateChanged"
                           Clearable="true"
                           MinDate="@MinAllowedDate"
                           MaxDate="DateTime.Today"
                           Dense="true" />
        </MudItem>

        <!-- TVL Filter -->
        <MudItem xs="12" md="6" lg="2">
            <MudNumericField T="decimal"
                             Label="Min TVL (USD)"
                             @bind-Value="Filters.MinTvlUsd"
                             Min="0"
                             Format="N2"
                             Clearable="true"
                             Dense="true" />
        </MudItem>

        <!-- Min Swaps -->
        <MudItem xs="12" md="6" lg="2">
            <MudNumericField T="int"
                             Label="Min Swaps"
                             @bind-Value="Filters.MinSwapCount"
                             Min="0"
                             Clearable="true"
                             Dense="true" />
        </MudItem>

        <!-- Min Price Diff -->
        <MudItem xs="12" md="6" lg="2">
            <MudNumericField T="decimal"
                             Label="Min Price Diff %"
                             @bind-Value="Filters.MinPriceDiffPercent"
                             Min="0"
                             Max="100"
                             Format="N2"
                             Clearable="true"
                             Dense="true" />
        </MudItem>

        <!-- Buttons -->
        <MudItem xs="12" md="6" lg="1" Class="d-flex align-center gap-2">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Small"
                       OnClick="ApplyFilters">
                Apply
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Secondary"
                       Size="Size.Small"
                       OnClick="ResetFilters">
                Reset
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

@code {
    [Parameter] public PoolFiltersModel Filters { get; set; } = new();
    [Parameter] public List<string> AvailableSecondTokens { get; set; } = new();
    [Parameter] public EventCallback OnFiltersChanged { get; set; }

    [Inject] public IDialogService DialogService { get; set; } = default!;

    private IEnumerable<string> SelectedSecondTokens
    {
        get => Filters.SecondTokenAddresses;
        set => Filters.SecondTokenAddresses = value.ToList();
    }

    // Minimum allowed date = today - 2 days (demo restriction)
    private DateTime MinAllowedDate => DateTime.UtcNow.Date.AddDays(-2);

    private async Task OnSwapsDateChanged(DateTime? newValue)
    {
        if (!newValue.HasValue)
        {
            Filters.SwapsFromDate = null;
            await NotifyChangeAsync();
            return;
        }

        var selected = newValue.Value.Date;

        if (selected < MinAllowedDate)
        {
            // Enforce demo restriction and show message
            Filters.SwapsFromDate = MinAllowedDate;

            await DialogService.ShowMessageBox(
                "Demo limitation",
                "The demo version allows setting a date no earlier than 3 days from the current date.",
                yesText: "OK");

            await NotifyChangeAsync();
            return;
        }

        Filters.SwapsFromDate = selected;
        await NotifyChangeAsync();
    }

    private async Task ApplyFilters() => await NotifyChangeAsync();

    private async Task ResetFilters()
    {
        Filters.Reset();
        await NotifyChangeAsync();
    }

    private async Task NotifyChangeAsync()
    {
        if (OnFiltersChanged.HasDelegate)
            await OnFiltersChanged.InvokeAsync();
    }
}
