@page "/"
@inject HttpClient Http
@inject IDialogService DialogService
@using System.Net.Http.Json
@using MudBlazor

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5">Portfolios</MudText>
    <MudDivider Class="my-2" />
    
    <div class="d-flex gap-2 mb-4">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddNewPortfolio">Add new</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="OpenConfigDialog">Config</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="DeleteSelectedPortfolio" Disabled="@(selectedPortfolio == null)">Delete</MudButton>
    </div>

    <MudTable 
        Items="@portfolios" 
        T="Portfolio" 
        Hover="true"
        Bordered="true"
        Breakpoint="Breakpoint.Sm"
        FixedHeader="true"
        Height="calc(100vh - 250px)"
        @bind-SelectedItem="selectedPortfolio"
        RowStyleFunc="@SelectedRowStyleFunc">
        <HeaderContent>
            <MudTh Style="width: 60px;">№</MudTh>
            <MudTh>Name</MudTh>
            <MudTh>Sol</MudTh>
            <MudTh>wSOL</MudTh>
            <MudTh>USDC</MudTh>
            <MudTh>All</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="№">@context.Number</MudTd>
            <MudTd DataLabel="Name">
                <MudTextField @bind-Value="context.Name" 
                              Margin="Margin.Dense" 
                              Variant="Variant.Text"
                              MaxLength="30"
                              Immediate="false"/>
            </MudTd>
            <MudTd DataLabel="Sol">@context.Sol</MudTd>
            <MudTd DataLabel="wSOL">@context.WSol</MudTd>
            <MudTd DataLabel="USDC">@context.Usdc</MudTd>
            <MudTd DataLabel="All">@context.All</MudTd>
        </RowTemplate>
    </MudTable>
</MudPaper>

@code {
    private List<Portfolio> portfolios = new List<Portfolio>
    {
        new Portfolio { Number = 1 },
        new Portfolio { Number = 2 },
        new Portfolio { Number = 3 }
    };
    
    private Portfolio? selectedPortfolio;

    private void AddNewPortfolio()
    {
        var newPortfolio = new Portfolio 
        { 
            Number = portfolios.Count + 1 
        };
        portfolios.Add(newPortfolio);
    }

    private void DeleteSelectedPortfolio()
    {
        if (selectedPortfolio != null)
        {
            portfolios.Remove(selectedPortfolio);
            RenumberPortfolios();
            selectedPortfolio = null;
        }
    }

    private void RenumberPortfolios()
    {
        for (int i = 0; i < portfolios.Count; i++)
        {
            portfolios[i].Number = i + 1;
        }
    }

    private string SelectedRowStyleFunc(Portfolio portfolio, int rowNumber)
    {
        if (selectedPortfolio != null && selectedPortfolio.Equals(portfolio))
        {
            return "background-color: #E3F2FD;";
        }
        return string.Empty;
    }

    private void OpenConfigDialog()
    {
        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Large, 
            FullWidth = true,
            CloseButton = true
        };
        DialogService.Show<WalletConfigDialog>("Collection of wallets", options);
    }

    private class Portfolio
    {
        public int Number { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Sol { get; set; } = string.Empty;
        public string WSol { get; set; } = string.Empty;
        public string Usdc { get; set; } = string.Empty;
        public string All { get; set; } = string.Empty;
    }
}
